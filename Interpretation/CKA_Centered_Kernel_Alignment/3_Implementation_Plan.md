# Implementation

## 목적

- 유사도를 기반으로 한 모델 추천 기능 구현
- 학습된 모델의 feature를 뽑아서 비교하기 위해 CKA(Centered Kernel Alignment)를 사용하기로 함.
- 모델과 모델을 비교해서 모델을 추천하고자 했었지만, CKA가 레이어와 레이어의 비교에 적합하고,
- 본 서비스가 레이어에 대한 관찰을 주 목적으로 한다는 점에서 레이어를 선택하면 가장 유사한 레이어를 가진 모델을 출력하는 것으로 기능을 구체화 함.

## CKA

- 이를 위해 각 레이어의 출력을 각 채널별로 **평균**내어서 데이터 셋 \* out_channel 형태의 CKA 행렬을 추출함.

  - 평균이 아닌, 분산이나 L-2 norm 을 사용하는 방안도 검토해 볼 수 있음.
  - 평균을 내면, 해당 채널의 활성도를 추출하다고 생각할 수 있음.

- kernel 함수는 **linear** 를 우선적으로 선택하였는데, 이후에 다른 함수를 검토해 볼 수 있음.

## DataBase

- 따라서 모델이 학습되고 나서 테스트를 거칠 때 모델의 convolution layer 마다의 출력을 데이터베이스에 저장해야 함.
  - 데이터베이스는 벡터 DB와 Postgresql 의 pgvector 중에 고민했고,
  - 벡터 DB 중 **Milvus가** 오픈소스이며, 컨테이너화가 가능하고, 사양이 적당하며 Hybrid Search 기능이 있어 확장성이 좋다고 판단해 선택했다.
  - 저장되는 데이터는,
    - layer가 속한 모델의 key와
    - 출력층의 벡터
      - 이때 출력층의 벡터는 Milvus가 Inner Product기반으로 유사도를 측정해주기 때문에 Frobenius norm 으로 나눠서 넣어준다.
  - 가 현재 최소 스펙이다.
